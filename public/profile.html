<!-- START OF FILE public/profile.html (UPDATED with Caching Logic) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - TOEFLÂ® Practice</title>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      :root {
        --bg-color: #f5f5f7;
        --card-bg: #fff;
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --accent-blue: #007aff;
        --accent-blue-hover: #0060c5;
        --border-color: #d2d2d7;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 24px;
      }
      .navbar {
        max-width: 1000px;
        margin: 20px auto 0;
        padding: 0 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-left,
      .nav-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .nav-link {
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
      }
      .main-container {
        max-width: 1000px;
        margin: 40px auto;
      }
      .section-header {
        font-size: 24px;
        font-weight: 700;
        margin-top: 40px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .section-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
      }
      .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 24px;
      }
      .settings-card {
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        background: #fff;
      }
      .settings-card h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
      }
      .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 6px;
        display: block;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        font-size: 15px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 90px;
      }
      .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        gap: 12px;
      }
      .form-actions button {
        background-color: var(--accent-blue);
        color: #fff;
        padding: 10px 18px;
        border: none;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .form-actions button:hover {
        background-color: var(--accent-blue-hover);
      }
      .status-pill {
        font-size: 13px;
        color: var(--text-secondary);
      }
      .status-pill.success {
        color: var(--accent-blue);
      }
      .status-pill.error {
        color: #ff3b30;
      }
      .meta-row {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 12px;
      }
      .header-actions button {
        background: transparent;
        border: 1px solid var(--accent-blue);
        color: var(--accent-blue);
        font-size: 14px;
        padding: 6px 16px;
        border-radius: 99px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .header-actions button:hover:not(:disabled) {
        background-color: var(--accent-blue);
        color: white;
      }
      .header-actions button:disabled {
        border-color: #d2d2d7;
        color: #d2d2d7;
        cursor: not-allowed;
      }
      .loading-state,
      .empty-state {
        text-align: center;
        color: var(--text-secondary);
        font-size: 16px;
        padding: 40px;
        background-color: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
      }
      .analysis-prompt-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
      }
      .analysis-prompt-card h3 {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 12px 0;
      }
      .analysis-prompt-card p {
        color: var(--text-secondary);
        max-width: 500px;
        margin: 0 auto 24px;
        line-height: 1.6;
      }
      #start-analysis-btn {
        background-color: var(--accent-blue);
        color: #fff;
        padding: 12px 28px;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
      }
      #start-analysis-btn:hover {
        background-color: var(--accent-blue-hover);
        transform: scale(1.05);
      }
      .profile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }
      .analysis-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
      }
      #wordcloud-canvas {
        width: 100% !important;
        height: 300px !important;
      }
      .ai-analysis-content {
        line-height: 1.7;
      }
      .ai-analysis-content h3 {
        font-size: 16px;
        margin-top: 20px;
        margin-bottom: 8px;
      }
      .ai-analysis-content ul {
        padding-left: 20px;
        margin: 0;
      }
      .ai-analysis-content li {
        margin-bottom: 12px;
      }
      .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }
      .achievement-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s ease;
      }
      .achievement-card.locked {
        opacity: 0.5;
      }
      .achievement-card.unlocked:hover {
        transform: translateY(-4px);
      }
      .achievement-icon {
        flex-shrink: 0;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #f0f0f5;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .achievement-card.unlocked .achievement-icon {
        background-color: #e4f8e9;
        color: #216e39;
      }
      .achievement-details h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 4px;
      }
      .achievement-details p {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="navbar"></div>
    <div class="main-container">
      <div class="section-card">
        <h2 style="margin-top: 0">Account Settings</h2>
        <div class="settings-grid">
          <form id="profile-form" class="settings-card">
            <h3>Profile Details</h3>
            <div class="form-group">
              <label for="profile-username">Username</label>
              <input id="profile-username" name="username" required />
            </div>
            <div class="form-group">
              <label for="profile-email">Email</label>
              <input type="email" id="profile-email" name="email" required />
            </div>
            <div class="form-group">
              <label for="profile-avatar">Avatar URL</label>
              <input
                type="url"
                id="profile-avatar"
                name="avatarUrl"
                placeholder="https://"
              />
            </div>
            <div class="form-group">
              <label for="profile-bio">Short Bio</label>
              <textarea
                id="profile-bio"
                name="bio"
                placeholder="Share your learning goals or strengths..."
              ></textarea>
            </div>
            <div class="meta-row">
              <span id="email-status" class="status-pill"></span>
              <span id="last-login" class="status-pill"></span>
            </div>
            <div class="form-actions">
              <span id="profile-status" class="status-pill"></span>
              <button type="submit">Save Profile</button>
            </div>
          </form>
          <form id="password-form" class="settings-card">
            <h3>Change Password</h3>
            <div class="form-group">
              <label for="current-password">Current Password</label>
              <input
                type="password"
                id="current-password"
                name="currentPassword"
                required
              />
            </div>
            <div class="form-group">
              <label for="new-password">New Password</label>
              <input
                type="password"
                id="new-password"
                name="newPassword"
                required
              />
            </div>
            <div class="form-actions">
              <span id="password-status" class="status-pill"></span>
              <button type="submit">Update Password</button>
            </div>
          </form>
        </div>
      </div>

      <div class="section-header">
        <span>Writing Analysis</span>
        <div class="header-actions" id="analysis-actions" style="display: none">
          <span
            style="
              font-size: 13px;
              color: var(--text-secondary);
              margin-right: 8px;
            "
            id="analysis-timestamp"
          ></span>
          <button id="rerun-analysis-btn">Re-run Analysis</button>
        </div>
      </div>
      <div id="analysis-section">
        <div class="loading-state">Loading analysis report...</div>
      </div>

      <h2 class="section-header">My Achievements</h2>
      <div class="achievements-grid" id="achievements-grid">
        <div class="loading-state">Loading achievements...</div>
      </div>
    </div>

    <script src="/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        const analysisSection = document.getElementById("analysis-section");
        const analysisActions = document.getElementById("analysis-actions");
        const analysisTimestamp = document.getElementById("analysis-timestamp");
        const rerunBtn = document.getElementById("rerun-analysis-btn");
        const achievementsGrid = document.getElementById("achievements-grid");
        const profileForm = document.getElementById("profile-form");
        const passwordForm = document.getElementById("password-form");
        const profileStatus = document.getElementById("profile-status");
        const passwordStatus = document.getElementById("password-status");
        const emailStatus = document.getElementById("email-status");
        const lastLoginEl = document.getElementById("last-login");

        const loadProfile = async () => {
          if (!profileForm) return;
          profileStatus.textContent = "Loading profile...";
          try {
            const response = await fetch("/api/user/profile", {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) {
              throw new Error("Unable to load profile.");
            }
            const data = await response.json();
            profileForm.username.value = data.username || "";
            profileForm.email.value = data.email || "";
            profileForm.avatarUrl.value = data.avatar_url || "";
            profileForm.bio.value = data.bio || "";
            emailStatus.textContent = data.email_verified
              ? "Email verified"
              : "Email pending verification";
            lastLoginEl.textContent = data.last_login_at
              ? `Last login: ${new Date(
                  data.last_login_at
                ).toLocaleString()}`
              : "Welcome! Let's get started.";
            profileStatus.textContent = "";
          } catch (error) {
            profileStatus.textContent = error.message;
          }
        };

        if (profileForm) {
          profileForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            profileStatus.textContent = "Saving...";
            profileStatus.className = "status-pill";
            const payload = {
              username: profileForm.username.value.trim(),
              email: profileForm.email.value.trim(),
              avatarUrl: profileForm.avatarUrl.value.trim(),
              bio: profileForm.bio.value.trim(),
            };
            try {
              const response = await fetch("/api/user/profile", {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(payload),
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.message || "Failed to update profile.");
              }
              emailStatus.textContent = data.profile.email_verified
                ? "Email verified"
                : "Email pending verification";
              lastLoginEl.textContent = data.profile.last_login_at
                ? `Last login: ${new Date(
                    data.profile.last_login_at
                  ).toLocaleString()}`
                : lastLoginEl.textContent;
              profileStatus.textContent = "Profile saved!";
              profileStatus.classList.add("success");
            } catch (error) {
              profileStatus.textContent = error.message;
              profileStatus.classList.add("error");
            }
          });
        }

        if (passwordForm) {
          passwordForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            passwordStatus.textContent = "Updating...";
            passwordStatus.className = "status-pill";
            const payload = {
              currentPassword: passwordForm.currentPassword.value,
              newPassword: passwordForm.newPassword.value,
            };
            try {
              const response = await fetch("/api/auth/change-password", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(payload),
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.message || "Failed to change password.");
              }
              passwordStatus.textContent = data.message;
              passwordStatus.classList.add("success");
              passwordForm.reset();
            } catch (error) {
              passwordStatus.textContent = error.message;
              passwordStatus.classList.add("error");
            }
          });
        }

        // --- [MODIFICATION 1/4]: Function to display the analysis data ---
        const displayAnalysisData = (data) => {
          analysisSection.innerHTML = `
            <div class="profile-grid">
                <div class="analysis-card">
                    <h3>High-Frequency Words</h3>
                    <canvas id="wordcloud-canvas"></canvas>
                </div>
                <div class="analysis-card">
                    <h3>AI Common Mistakes Summary</h3>
                    <div id="ai-analysis-content" class="ai-analysis-content"></div>
                </div>
            </div>`;

          WordCloud(document.getElementById("wordcloud-canvas"), {
            list: data.wordCloud.map((d) => [d.text, d.value * 20]),
            gridSize: Math.round(
              (16 * document.getElementById("wordcloud-canvas").width) / 1024
            ),
            weightFactor: 2,
            fontFamily: "Inter, sans-serif",
            color: "random-dark",
            backgroundColor: "#fff",
          });

          document.getElementById("ai-analysis-content").innerHTML =
            marked.parse(data.commonMistakes);

          // Show the "Re-run" button and timestamp
          if (data.analyzedAt) {
            const date = new Date(data.analyzedAt).toLocaleString();
            analysisTimestamp.textContent = `Last run: ${date}`;
          }
          analysisActions.style.display = "flex";
          rerunBtn.disabled = false;
          rerunBtn.textContent = "Re-run Analysis";
        };

        // --- [MODIFICATION 2/4]: Function to show the "Start Analysis" prompt ---
        const showStartPrompt = (message) => {
          analysisActions.style.display = "none";
          analysisSection.innerHTML = `
                <div class="analysis-prompt-card">
                  <h3>Generate Your Personalized Writing Report</h3>
                  <p>${message}</p>
                  <button id="start-analysis-btn">Start Analysis</button>
                </div>`;
          document
            .getElementById("start-analysis-btn")
            .addEventListener("click", runNewAnalysis);
        };

        // --- [MODIFICATION 3/4]: Function to trigger a NEW analysis via POST ---
        const runNewAnalysis = async () => {
          analysisSection.innerHTML = `<div class="loading-state">Analyzing your writing... This may take up to 30 seconds.</div>`;
          analysisActions.style.display = "flex";
          rerunBtn.disabled = true;
          rerunBtn.textContent = "Analyzing...";

          try {
            const response = await fetch("/api/user/writing-analysis", {
              method: "POST", // Use POST to create a new analysis
              headers: { Authorization: `Bearer ${token}` },
            });
            const data = await response.json();
            if (!response.ok) {
              // Handle specific error for not enough data
              if (response.status === 400) {
                showStartPrompt(data.message);
                return;
              }
              throw new Error(data.message || "Failed to run analysis.");
            }
            displayAnalysisData(data); // Display the newly generated data
          } catch (error) {
            analysisSection.innerHTML = `<div class="empty-state">${error.message}</div>`;
            analysisActions.style.display = "none";
          }
        };

        // --- [MODIFICATION 4/4]: Initial page load logic ---
        const loadInitialData = async () => {
          try {
            // Try to GET the last analysis
            const response = await fetch("/api/user/writing-analysis", {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (response.ok) {
              const data = await response.json();
              displayAnalysisData(data);
            } else if (response.status === 404) {
              // 404 means no analysis exists, show the initial prompt
              showStartPrompt(
                "Get an AI-powered summary of your high-frequency words and common mistakes based on all your practice sessions. This may take up to 30 seconds."
              );
            } else {
              const errorData = await response.json();
              throw new Error(errorData.message || "Failed to load analysis.");
            }
          } catch (error) {
            analysisSection.innerHTML = `<div class="empty-state">${error.message}</div>`;
          }
        };

        const renderAchievements = async () => {
          try {
            const response = await fetch("/api/user/achievements", {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) throw new Error("Failed to load achievements");
            const achievements = await response.json();
            achievementsGrid.innerHTML = "";
            if (achievements.length === 0) {
              achievementsGrid.innerHTML = `<div class="empty-state">No achievements available yet.</div>`;
              return;
            }
            achievements.forEach((ach) => {
              const card = document.createElement("div");
              card.className = `achievement-card ${
                ach.unlocked ? "unlocked" : "locked"
              }`;
              const iconSVG = ach.unlocked
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`
                : `<svg xmlns="http://www.w.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
              card.innerHTML = `<div class="achievement-icon">${iconSVG}</div><div class="achievement-details"><h3>${ach.name}</h3><p>${ach.description}</p></div>`;
              achievementsGrid.appendChild(card);
            });
          } catch (error) {
            achievementsGrid.innerHTML = `<div class="empty-state">${error.message}</div>`;
          }
        };

        rerunBtn.addEventListener("click", runNewAnalysis);

        loadProfile();
        loadInitialData();
        renderAchievements();
      });
    </script>
  </body>
</html>
Z
