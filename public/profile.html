<!-- START OF FILE public/profile.html (Calendar Final Fix & Polish) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - TOEFL® Practice</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      :root {
        --bg-color: #f5f5f7;
        --card-bg: #fff;
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --accent-blue: #007aff;
        --border-color: #d2d2d7;
        --heatmap-color-0: #ebedf0;
        --heatmap-color-1: #9be9a8;
        --heatmap-color-2: #40c463;
        --heatmap-color-3: #30a14e;
        --heatmap-color-4: #216e39;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 24px;
      }
      .navbar {
        max-width: 1000px;
        margin: 20px auto 0;
        padding: 0 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-link {
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
      }
      .nav-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .main-container {
        max-width: 1000px;
        margin: 40px auto;
      }
      .section-header {
        font-size: 24px;
        font-weight: 700;
        margin-top: 40px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
      }
      .loading-state,
      .empty-state {
        text-align: center;
        color: var(--text-secondary);
        font-size: 16px;
        padding: 40px;
      }

      /* --- 【关键变更】: 全新的日历样式 --- */
      .calendar-wrapper {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        overflow-x: auto;
      }
      .calendar-container {
        position: relative;
      }
      .calendar-grid {
        display: grid;
        grid-auto-flow: column;
        grid-template-rows: repeat(7, auto);
        grid-template-columns: repeat(53, auto);
        gap: 4px;
      }
      .month-label {
        position: absolute;
        top: -20px;
        font-size: 12px;
        color: var(--text-secondary);
      }
      .day {
        width: 14px;
        height: 14px;
        background-color: var(--heatmap-color-0);
        border-radius: 3px;
      }
      .day[data-level="1"] {
        background-color: var(--heatmap-color-1);
      }
      .day[data-level="2"] {
        background-color: var(--heatmap-color-2);
      }
      .day[data-level="3"] {
        background-color: var(--heatmap-color-3);
      }
      .day[data-level="4"] {
        background-color: var(--heatmap-color-4);
      }
      .calendar-legend {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Achievements Styles */
      .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }
      .achievement-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s ease;
      }
      .achievement-card.locked {
        opacity: 0.5;
      }
      .achievement-card.unlocked:hover {
        transform: translateY(-4px);
      }
      .achievement-icon {
        flex-shrink: 0;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #f0f0f5;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .achievement-card.unlocked .achievement-icon {
        background-color: #e4f8e9;
        color: var(--heatmap-color-4);
      }
      .achievement-details h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 4px;
      }
      .achievement-details p {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="navbar"></div>
    <div class="main-container">
      <h2 class="section-header">Practice Calendar</h2>
      <div class="calendar-wrapper" id="calendar-wrapper">
        <div class="loading-state">Loading calendar...</div>
      </div>

      <h2 class="section-header">My Achievements</h2>
      <div class="achievements-grid" id="achievements-grid">
        <div class="loading-state">Loading achievements...</div>
      </div>
    </div>

    <script src="/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login.html";
          return;
        }

        const calendarWrapper = document.getElementById("calendar-wrapper");
        const achievementsGrid = document.getElementById("achievements-grid");

        // --- 【关键变更】: 最终版日历渲染函数 ---
        const renderCalendar = async () => {
          try {
            const response = await fetch("/api/user/practice-calendar", {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) throw new Error("Failed to load calendar data");
            const practiceDates = await response.json();

            const practiceCounts = practiceDates.reduce((acc, date) => {
              const dateString = date.split("T")[0];
              acc[dateString] = (acc[dateString] || 0) + 1;
              return acc;
            }, {});

            calendarWrapper.innerHTML = `
                        <div class="calendar-container" id="calendar-container">
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                        <div class="calendar-legend">
                            Less &nbsp;
                            <div class="day" style="background-color: var(--heatmap-color-0)"></div>
                            <div class="day" style="background-color: var(--heatmap-color-1)"></div>
                            <div class="day" style="background-color: var(--heatmap-color-2)"></div>
                            <div class="day" style="background-color: var(--heatmap-color-3)"></div>
                            <div class="day" style="background-color: var(--heatmap-color-4)"></div>
                            &nbsp; More
                        </div>
                    `;

            const container = document.getElementById("calendar-container");
            const grid = document.getElementById("calendar-grid");
            const today = new Date();
            const daysInYear = 365 + 7; // show 53 weeks
            const startDate = new Date();
            startDate.setDate(today.getDate() - daysInYear + 1);

            const days = [];
            for (let i = 0; i < daysInYear; i++) {
              const d = new Date(startDate);
              d.setDate(d.getDate() + i);
              days.push(d);
            }

            const monthLabels = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            const monthPositions = {};

            days.forEach((d, i) => {
              const weekIndex = Math.floor(i / 7);
              const dayOfWeek = i % 7;

              if (dayOfWeek === 0 && d.getDate() <= 7) {
                const monthIndex = d.getMonth();
                if (!monthPositions[monthIndex]) {
                  monthPositions[monthIndex] = weekIndex;
                }
              }

              const dayEl = document.createElement("div");
              dayEl.className = "day";
              dayEl.style.gridColumnStart = weekIndex + 1;
              dayEl.style.gridRowStart = dayOfWeek + 1;

              const dateString = d.toISOString().split("T")[0];
              const count = practiceCounts[dateString] || 0;
              let level = 0;
              if (count > 0) level = 1;
              if (count >= 2) level = 2;
              if (count >= 4) level = 3;
              if (count >= 6) level = 4;

              if (level > 0) {
                dayEl.dataset.level = level;
              }
              dayEl.title = `${count} practices on ${d.toLocaleDateString()}`;
              grid.appendChild(dayEl);
            });

            // Add month labels
            for (const monthIndex in monthPositions) {
              const weekIndex = monthPositions[monthIndex];
              const monthLabel = document.createElement("div");
              monthLabel.className = "month-label";
              monthLabel.textContent = monthLabels[monthIndex];
              monthLabel.style.left = `${weekIndex * 18}px`; // 14px width + 4px gap
              container.appendChild(monthLabel);
            }
          } catch (error) {
            calendarWrapper.innerHTML = `<div class="empty-state">${error.message}</div>`;
          }
        };

        const renderAchievements = async () => {
          try {
            const response = await fetch("/api/user/achievements", {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) throw new Error("Failed to load achievements");
            const achievements = await response.json();
            achievementsGrid.innerHTML = "";
            if (achievements.length === 0) {
              achievementsGrid.innerHTML = `<div class="empty-state">No achievements available yet.</div>`;
              return;
            }
            achievements.forEach((ach) => {
              const card = document.createElement("div");
              card.className = `achievement-card ${
                ach.unlocked ? "unlocked" : "locked"
              }`;
              const iconSVG = ach.unlocked
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
              card.innerHTML = `<div class="achievement-icon">${iconSVG}</div><div class="achievement-details"><h3>${ach.name}</h3><p>${ach.description}</p></div>`;
              achievementsGrid.appendChild(card);
            });
          } catch (error) {
            achievementsGrid.innerHTML = `<div class="empty-state">${error.message}</div>`;
          }
        };

        renderCalendar();
        renderAchievements();
      });
    </script>
  </body>
</html>
