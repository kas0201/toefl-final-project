<!-- START OF FILE public/integrated-practice.html (FINAL OPTIMIZED VERSION with Pre-loading) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Integrated Writing - TOEFL® Practice</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap");
      :root {
        --bg-color: #f5f5f7;
        --card-bg: #ffffff;
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --accent-blue: #007aff;
        --border-color: #d2d2d7;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-color);
        margin: 0;
      }
      .exam-header {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 16px 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .exam-header h1 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
      }
      .exam-header .timer {
        font-family: "Roboto Mono", monospace;
        font-size: 20px;
        font-weight: 500;
      }
      .main-container {
        max-width: 1200px;
        margin: 32px auto;
        padding: 0 32px;
        display: grid;
        gap: 32px;
      }
      .content-panel {
        background-color: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border-color);
        padding: 32px;
        height: calc(100vh - 160px);
        overflow-y: auto;
        box-sizing: border-box;
      }
      .content-panel h2 {
        font-size: 22px;
        margin-top: 0;
      }
      .content-panel p {
        font-size: 17px;
        line-height: 1.7;
        color: var(--text-secondary);
        white-space: pre-wrap;
      }
      .writing-panel {
        background-color: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border-color);
        padding: 32px;
        height: calc(100vh - 160px);
        overflow-y: auto;
        box-sizing: border-box;
      }
      .writing-panel.inactive {
        background-color: var(--bg-color);
        border: none;
        box-shadow: none;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .inactive-message {
        font-size: 18px;
        color: var(--text-secondary);
      }
      #user-textarea {
        width: 100%;
        height: calc(100% - 80px);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        font-size: 16px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
      }
      .controls-container {
        margin-top: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #word-count {
        font-size: 15px;
        color: var(--text-secondary);
        font-weight: 500;
      }
      #submit-btn {
        padding: 10px 24px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 999px;
        cursor: pointer;
        border: none;
        background-color: var(--accent-blue);
        color: #fff;
      }
      #submit-btn:disabled {
        background-color: #e5e5ea;
        color: var(--text-secondary);
        cursor: not-allowed;
      }
      #status-message {
        text-align: center;
        margin-top: 24px;
        font-weight: 500;
        height: 20px;
      }
      .audio-status-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        text-align: center;
      }
      .audio-status-container p {
        font-size: 18px;
        color: var(--text-secondary);
        margin: 0;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .spinner {
        width: 32px;
        height: 32px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--accent-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body>
    <div class="exam-header">
      <h1 id="phase-title">Integrated Writing</h1>
      <div class="timer" id="phase-timer">--:--</div>
    </div>
    <div class="main-container" id="main-container"></div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) window.location.href = "/login.html";

      const phaseTitleEl = document.getElementById("phase-title");
      const phaseTimerEl = document.getElementById("phase-timer");
      const mainContainer = document.getElementById("main-container");

      let timer;
      let pollingInterval;
      let currentQuestion = null;

      // --- 【优化 1/3】: 新增一个函数，专门用来在后台悄悄地触发音频生成 ---
      const preloadAudio = async () => {
        // 如果题目数据中已经有音频URL，或者没有题目数据，就什么都不做
        if (!currentQuestion || currentQuestion.lecture_audio_url) {
          return;
        }
        console.log("Preloading audio in the background...");
        try {
          // 向后台发送“开始生成音频”的命令，“发射后不管”
          await fetch(
            `/api/questions/${currentQuestion.id}/trigger-audio-generation`,
            {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
        } catch (error) {
          console.error("Failed to trigger audio preloading:", error);
          // 预加载失败也没关系，听力阶段会再次尝试
        }
      };

      function renderReadingPhase() {
        phaseTitleEl.textContent = "Phase 1: Reading";
        mainContainer.style.gridTemplateColumns = "1fr 1fr";
        mainContainer.innerHTML = `<div class="content-panel"><h2>Reading Passage</h2><p>${currentQuestion.reading_passage}</p></div><div class="writing-panel inactive"><p class="inactive-message">You will be able to write after the lecture.</p></div>`;

        // --- 【优化 2/3】: 在阅读计时开始的同时，调用预加载函数 ---
        preloadAudio();

        startTimer(180, renderLecturePhase);
      }

      async function renderLecturePhase() {
        phaseTitleEl.textContent = "Phase 2: Lecture";
        mainContainer.style.gridTemplateColumns = "1fr";
        clearInterval(pollingInterval);

        const renderAudioPlayer = (audioUrl) => {
          mainContainer.innerHTML = `<div class="content-panel" style="display:flex; flex-direction:column; align-items:center; justify-content:center;"><p style="font-size: 18px;">Listen carefully to the lecture.</p><audio id="lecture-audio" src="${audioUrl}" controls autoplay></audio></div>`;
          const audioEl = document.getElementById("lecture-audio");
          phaseTimerEl.textContent = "Playing...";
          audioEl.onended = renderWritingPhase;
          audioEl.onerror = () => {
            mainContainer.innerHTML = `<div class="content-panel"><h2>Lecture Script (Audio Failed)</h2><p>${currentQuestion.lecture_script}</p></div>`;
            startTimer(120, renderWritingPhase);
          };
        };

        const startPollingForAudio = () => {
          mainContainer.innerHTML = `<div class="content-panel audio-status-container"><div class="spinner"></div><p>Lecture audio is being prepared...<br>This may take a minute. The page will update automatically.</p></div>`;
          phaseTimerEl.textContent = "Waiting...";

          pollingInterval = setInterval(async () => {
            try {
              const statusResponse = await fetch(
                `/api/questions/${currentQuestion.id}/audio-status`,
                {
                  headers: { Authorization: `Bearer ${token}` },
                }
              );
              if (!statusResponse.ok) return;
              const statusData = await statusResponse.json();
              if (statusData.lecture_audio_url) {
                clearInterval(pollingInterval);
                currentQuestion.lecture_audio_url =
                  statusData.lecture_audio_url;
                renderAudioPlayer(statusData.lecture_audio_url);
              }
            } catch (error) {
              console.error("Polling error:", error);
            }
          }, 5000);
        };

        // --- 【优化 3/3】: 听力阶段开始时，先直接检查一次音频状态 ---
        // 因为很可能在阅读的三分钟内，音频已经生成好了！
        try {
          const initialStatusCheck = await fetch(
            `/api/questions/${currentQuestion.id}/audio-status`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const initialData = await initialStatusCheck.json();
          if (initialData.lecture_audio_url) {
            // 太棒了，音频已经准备好了，直接播放！
            currentQuestion.lecture_audio_url = initialData.lecture_audio_url;
            renderAudioPlayer(initialData.lecture_audio_url);
          } else {
            // 如果音频还没好，那就开始轮询（并确保触发命令被再次发送以防万一）
            await fetch(
              `/api/questions/${currentQuestion.id}/trigger-audio-generation`,
              {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            startPollingForAudio();
          }
        } catch (error) {
          console.error(
            "Initial audio check failed, falling back to script:",
            error
          );
          mainContainer.innerHTML = `<div class="content-panel"><h2>Lecture Script (Audio Service Unavailable)</h2><p>${currentQuestion.lecture_script}</p></div>`;
          startTimer(120, renderWritingPhase);
        }
      }

      function renderWritingPhase() {
        phaseTitleEl.textContent = "Phase 3: Writing";
        mainContainer.style.gridTemplateColumns = "1fr 1fr";
        mainContainer.innerHTML = `
                <div class="content-panel"><h2>Reading Passage Reference</h2><p>${currentQuestion.reading_passage}</p></div>
                <div class="writing-panel" id="writing-panel"></div>`;
        renderWritingArea();
        startTimer(1200, () => {
          alert("Time's Up!");
          submitResponse(true);
        });
      }

      function renderWritingArea() {
        document.getElementById(
          "writing-panel"
        ).innerHTML = `<h2>Your Response</h2><textarea id="user-textarea"></textarea><div class="controls-container"><div id="word-count">Words: 0</div><button id="submit-btn" onclick="submitResponse(false)">Submit</button></div><p id="status-message"></p>`;
        document
          .getElementById("user-textarea")
          .addEventListener("input", (e) => {
            const words = e.target.value.trim().match(/\S+/g)?.length || 0;
            document.getElementById(
              "word-count"
            ).textContent = `Words: ${words}`;
          });
      }

      function startTimer(duration, onComplete) {
        clearInterval(timer);
        let timeRemaining = duration;
        const updateDisplay = () => {
          const minutes = Math.floor(timeRemaining / 60)
            .toString()
            .padStart(2, "0");
          const seconds = (timeRemaining % 60).toString().padStart(2, "0");
          phaseTimerEl.textContent = `${minutes}:${seconds}`;
        };
        updateDisplay();
        timer = setInterval(() => {
          timeRemaining--;
          updateDisplay();
          if (timeRemaining <= 0) {
            clearInterval(timer);
            onComplete();
          }
        }, 1000);
      }

      async function submitResponse(force = false) {
        const submitBtn = document.getElementById("submit-btn");
        const textarea = document.getElementById("user-textarea");
        const statusMessageEl = document.getElementById("status-message");
        const content = textarea.value;
        const wordCount = content ? content.trim().match(/\S+/g).length : 0;
        if (wordCount === 0 && !force) {
          alert("Cannot submit an empty response.");
          return;
        }
        statusMessageEl.textContent = "Submitting...";
        submitBtn.disabled = true;
        try {
          const response = await fetch("/api/submit-response", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              content,
              wordCount,
              questionId: currentQuestion.id,
              task_type: "integrated_writing",
            }),
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.message);
          window.location.href = `/submission-success.html?id=${result.id}`;
        } catch (error) {
          statusMessageEl.innerHTML = `<span style="color: var(--accent-red);_EXCLAMATION_">✗ ${error.message}</span>`;
          submitBtn.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const questionId = urlParams.get("id");
        if (!questionId) {
          mainContainer.innerHTML = `<h2>Error</h2><p>No question ID provided.</p>`;
          return;
        }
        try {
          const response = await fetch(`/api/questions/${questionId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (!response.ok)
            throw new Error("Failed to fetch question details.");
          currentQuestion = await response.json();
          renderReadingPhase();
        } catch (error) {
          console.error("Error fetching question:", error);
          mainContainer.innerHTML = `<h2>Error</h2><p>Could not load the question.</p>`;
        }
      });
    </script>
  </body>
</html>
