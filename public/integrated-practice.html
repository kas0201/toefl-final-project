<!-- START OF FILE public/integrated-practice.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Writing - TOEFL® Practice</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap');

        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent-blue: #007aff;
            --accent-red: #ff453a;
            --border-color: #d2d2d7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        .exam-header {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

            .exam-header h1 {
                font-size: 20px;
                font-weight: 600;
                margin: 0;
                color: var(--text-primary);
            }

            .exam-header .timer {
                font-family: 'Roboto Mono', monospace;
                font-size: 20px;
                font-weight: 500;
                color: var(--text-primary);
            }

        .main-container {
            max-width: 1200px;
            margin: 32px auto;
            padding: 0 32px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .content-panel, .writing-panel {
            background-color: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            padding: 32px;
            height: calc(100vh - 160px);
            overflow-y: auto;
        }

            .content-panel h2 {
                font-size: 22px;
                margin-top: 0;
            }

            .content-panel p {
                font-size: 17px;
                line-height: 1.7;
                color: var(--text-secondary);
                white-space: pre-wrap;
            }

            .writing-panel h2 {
                font-size: 22px;
                margin-top: 0;
            }

            .writing-panel.inactive {
                background-color: #f5f5f7;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }

        .inactive-message {
            font-size: 18px;
            color: var(--text-secondary);
        }

        #user-textarea {
            width: 100%;
            height: calc(100% - 80px); /* Adjust height to fit controls */
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            box-sizing: border-box;
        }

        .controls-container {
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #word-count {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        #submit-btn {
            padding: 10px 24px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 999px;
            cursor: pointer;
            border: none;
            background-color: var(--accent-blue);
            color: #fff;
        }

            #submit-btn:disabled {
                background-color: #e5e5ea;
                color: var(--text-secondary);
                cursor: not-allowed;
            }

        #status-message {
            text-align: center;
            margin-top: 24px;
            font-weight: 500;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="exam-header">
        <h1 id="phase-title">Integrated Writing</h1>
        <div class="timer" id="phase-timer">--:--</div>
    </div>
    <div class="main-container">
        <div class="content-panel" id="content-panel">
            <!-- Content will be injected here -->
        </div>
        <div class="writing-panel inactive" id="writing-panel">
            <!-- Writing area will be injected here -->
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        const phaseTitleEl = document.getElementById('phase-title');
        const phaseTimerEl = document.getElementById('phase-timer');
        const contentPanelEl = document.getElementById('content-panel');
        const writingPanelEl = document.getElementById('writing-panel');

        let timer;
        let currentQuestion = null;

        // --- Phase 1: Reading ---
        function renderReadingPhase() {
            phaseTitleEl.textContent = "Phase 1: Reading";
            contentPanelEl.innerHTML = `<h2>Reading Passage</h2><p>${currentQuestion.reading_passage}</p>`;
            writingPanelEl.classList.add('inactive');
            writingPanelEl.innerHTML = `<p class="inactive-message">You will be able to write your response after the reading and lecture phases.</p>`;
            startTimer(180, renderLecturePhase); // 3 minutes, then move to lecture
        }

        // --- Phase 2: Lecture Script ---
        function renderLecturePhase() {
            phaseTitleEl.textContent = "Phase 2: Lecture";
            // CRITICAL: Reading passage disappears
            contentPanelEl.innerHTML = `<h2>Lecture Script</h2><p>${currentQuestion.lecture_script}</p>`;
            writingPanelEl.classList.add('inactive'); // Keep it inactive
            startTimer(120, renderWritingPhase); // 2 minutes, then move to writing
        }

        // --- Phase 3: Writing ---
        function renderWritingPhase() {
            phaseTitleEl.textContent = "Phase 3: Writing";
            // CRITICAL: Lecture script disappears, Reading passage reappears
            contentPanelEl.innerHTML = `<h2>Reading Passage Reference</h2><p>${currentQuestion.reading_passage}</p>`;

            writingPanelEl.classList.remove('inactive');
            writingPanelEl.innerHTML = `
                    <h2>Your Response</h2>
                    <textarea id="user-textarea" placeholder="Summarize the points made in the lecture, explaining how they challenge the points made in the reading passage."></textarea>
                    <div class="controls-container">
                        <div id="word-count">Words: 0</div>
                        <button id="submit-btn">Submit</button>
                    </div>
                    <p id="status-message"></p>
                `;

            const textarea = document.getElementById('user-textarea');
            const wordCountEl = document.getElementById('word-count');
            const submitBtn = document.getElementById('submit-btn');

            textarea.addEventListener('input', () => {
                const words = textarea.value.trim().match(/\S+/g)?.length || 0;
                wordCountEl.textContent = `Words: ${words}`;
            });
            submitBtn.addEventListener('click', submitResponse);

            startTimer(1200, () => { // 20 minutes
                alert("Time's Up! Automatically submitting your response.");
                submitResponse(true);
            });
        }

        function startTimer(duration, onComplete) {
            clearInterval(timer);
            let timeRemaining = duration;
            const updateDisplay = () => {
                const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (timeRemaining % 60).toString().padStart(2, '0');
                phaseTimerEl.textContent = `${minutes}:${seconds}`;
            };
            updateDisplay();
            timer = setInterval(() => {
                timeRemaining--;
                updateDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    onComplete();
                }
            }, 1000);
        }

        async function submitResponse(force = false) {
            const submitBtn = document.getElementById('submit-btn');
            const textarea = document.getElementById('user-textarea');
            const statusMessageEl = document.getElementById('status-message');
            const content = textarea.value;
            const wordCount = content ? content.trim().match(/\S+/g).length : 0;

            if (wordCount === 0 && !force) {
                alert("Cannot submit an empty response.");
                return;
            }

            statusMessageEl.textContent = "Submitting...";
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/submit-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        content: content,
                        wordCount: wordCount,
                        questionId: currentQuestion.id,
                        task_type: 'integrated_writing'
                    }),
                });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.message);
                }
                statusMessageEl.innerHTML = `<span style="color: var(--accent-green);">✓ Submission successful!</span>`;
                textarea.disabled = true;
                clearInterval(timer);
            } catch (error) {
                statusMessageEl.innerHTML = `<span style="color: var(--accent-red);">✗ ${error.message}</span>`;
                submitBtn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const questionId = urlParams.get('id');
            if (!questionId) {
                contentPanelEl.innerHTML = `<h2>Error</h2><p>No question ID provided. Please select a task from the Practice Center.</p>`;
                return;
            }
            try {
                const response = await fetch(`/api/questions/${questionId}`);
                if (!response.ok) throw new Error('Failed to fetch question details.');
                currentQuestion = await response.json();
                renderReadingPhase(); // Start the test flow
            } catch (error) {
                console.error('Error fetching question:', error);
                contentPanelEl.innerHTML = `<h2>Error</h2><p>Could not load the question. Please try again later.</p>`;
            }
        });
    </script>
</body>
</html>